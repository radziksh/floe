if(b4w.module_check("game_config"))throw"Failed to register module: game_config";
b4w.register("game_config",function(a,b){a.DEFAULT_POS=new Float32Array([0,-4,0]);a.GEM_OFFSET=new Float32Array([0,1,0]);a.GEM_ROT_OFFSET=new Float32Array([0,0,0,1]);a.GEM_SCALE_OFFSET=.6;a.CL_BLUE=0;a.CL_PURPLE=1;a.CL_RED=2;a.CL_GREEN=3;a.CL_YELLOW=4;a.CL_MULTI=5;a.ROT_SPEED=2;a.CAM_SOFTNESS=.2;a.CAM_OFFSET=new Float32Array([0,6,-16]);a.CHAR_RAY_LENGTH=1.2;a.MAX_CHAR_HP=100;a.CHAR_ATTACK_DIST=2;a.CHAR_ATTACK_STR=35;a.CHAR_ATTACK_ANIM_FRAME=12;a.CH_STILL=0;a.CH_RUN=1;a.CH_ATTACK=2;a.LAVA_DAMAGE_INTERVAL=
.01;a.BONUS_SPAWN_CHANCE=.5;a.BONUS_HP_INCR=30;a.BONUS_SHIELD_TIME=10;a.BONUS_SHIELD_EFFECT=.33;a.BONUS_LAVA_PROT_TIME=15;a.BONUS_LIFETIME=10;a.BONUS_FLASH_SPEED=3;a.SHIELD_FLASH_LENGTH=.9;a.LAVA_FALL_LENGTH=1;a.GOLEM_SPEED=.8;a.GOLEM_ROT_SPEED=1;a.GOLEM_ATTACK_DIST=2;a.GOLEM_ATTACK_STRENGTH=20;a.GOLEM_ATTACK_ANIM_FRAME=30;a.GOLEMS_SPAWN_INTERVAL=3;a.GOLEM_HP=100;a.GS_WALKING=0;a.GS_ATTACKING=1;a.GS_GETTING_OUT=2;a.GS_NONE=3;a.EN_TYPE_GOLEM_LAVA=0;a.EN_TYPE_GOLEM_STONE=1;a.GT_POINT=0;a.GT_CHAR=1;
a.GT_OBELISK=2;a.HP_BONUSES_EMPTIES=["potion_hp","potion_hp.001","potion_hp.002"];a.SHIELD_BONUSES_EMPTIES=["potion_def"];a.LAVA_BONUSES_EMPTIES=["potion_lava"];a.GOLEM_LAVA_DEATH_EMPTY=["golem_lava_death"];a.GOLEM_DEATH_RIG=["golem_death_armature"];a.GOLEM_DEATH_BLOW=["golem_death_blow"];a.GM_SPARE=0;a.GM_CARRIED=1;a.GM_LAYING=2;a.SHUTTER_EMITTER_EMPTY="shutter_glass";a.SHUTTER_EMITTER_NAME="glass_shutter_emitter";a.CHAR_RUN_SPEAKER="character_run";a.CHAR_ATTACK_SPEAKER="sword_miss";a.CHAR_ATTACK_VOICE_SPKS=
["character_voice_atack_01","character_voice_atack_02","character_voice_atack_03"];a.CHAR_HURT_SPKS=["character_voice_hurt_01","character_voice_hurt_02"];a.CHAR_JUMP_SPKS=["character_voice_jump_01","character_voice_jump_02"];a.CHAR_SWORD_SPEAKER="sword_hit";a.CHAR_DEATH_SPEAKER="character_voice_death_01";a.CHAR_LANDING_SPEAKER="character_jump_ends";a.GEM_PICKUP_SPEAKER="gem_pickup";a.GEM_MOUNT_SPEAKER="gem_mount";a.CHAR_HEAL_SPEAKER="bonus_heal";a.CHAR_LAVA_SPEAKER="bonus_lava";a.CHAR_SHIELD_SPEAKER=
"bonus_shield";a.GOLEM_WALK_SPEAKER="golem_walk";a.GOLEM_ATTACK_SPEAKER="golem_atack_miss";a.GOLEM_HIT_SPEAKER="golem_atack_hit";a.GOLEM_GETOUT_SPEAKER="golem_getout";a.GEM_DESTR_SPEAKER="gem_destroy";a.WIN_SPEAKER="final_win";a.BTYPE_HP=0;a.BTYPE_LAVA=1;a.BTYPE_SHIELD=2});if(b4w.module_check("obelisks"))throw"Failed to register module: obelisks";
b4w.register("obelisks",function(a,b){function G(c){switch(c){case "BG":return d.CL_BLUE;case "RG":return d.CL_RED;case "GG":return d.CL_GREEN;case "YG":return d.CL_YELLOW;case "PG":return d.CL_PURPLE}}function C(){for(var d=0;d<t.NUM_OBELISKS;d++){var c=t.ISLES_SHIELD_DUPLI_NAME_LIST;c[2]="island_shield_"+d;c=k.get_object_by_dupli_name_list(c);r.stop(c);r.set_behavior(c,r.AB_FINISH_STOP)}}function n(d,a){var b="obelisk_"+d,l=w[d];if(0<a){var g=t.OBELISKS_GEMS_NAME[d]+"_0"+(l.num_gems+1),b=k.get_object_by_dupli_name(b,
g);k.show_object(b);c.play_def(q);l.gem_health=t.OBELISK_GEM_HEALTH}else if(0>a){g=t.OBELISKS_GEMS_NAME[d]+"_0"+l.num_gems;b=k.get_object_by_dupli_name(b,g);k.hide_object(b);var g=R,m=K;h.get_translation(b,g);h.get_rotation(b,m);e(g,m)}l.num_gems+=a;v(d)}function v(a){if(x(a)&&("volcano"!=t.LEVEL_NAME||!A.island_has_enemies(a))){if("volcano"==t.LEVEL_NAME){var b=t.ISLES_SHIELD_DUPLI_NAME_LIST;b[2]="island_shield_"+a;b=k.get_object_by_dupli_name_list(b);r.play(b);a=k.get_object_by_dupli_name("obelisk_"+
a,t.ISLAND_SPEAKER);c.play_def(a)}a:{for(a=0;a<t.NUM_OBELISKS;a++)if(!x(a)){a=!1;break a}a=!0}a&&(l.disable_controls(),g.disable_environment(),c.clear_playlist(),a=k.get_object_by_name(d.WIN_SPEAKER),c.play_def(a),a=l.get_wrapper(),r.apply(a.rig,"character_idle_01"),r.set_behavior(a.rig,r.AB_CYCLIC),r.play(a.rig),p())}}function e(a,b){var q=k.get_object_by_dupli_name(d.SHUTTER_EMITTER_EMPTY,d.SHUTTER_EMITTER_NAME);h.set_translation_v(q,a);h.set_rotation_v(q,b);k.show_object(q);r.play(q,function(){k.hide_object(q)});
var l=k.get_object_by_dupli_name(d.SHUTTER_EMITTER_EMPTY,d.GEM_DESTR_SPEAKER);c.play_def(l)}function p(){y.show_victory_element(1);z.check_sensor_manifold(null,"UPDATE_VIC_INTERFACE")&&z.remove_sensor_manifold(null,"UPDATE_VIC_INTERFACE");z.create_sensor_manifold(null,"UPDATE_VIC_INTERFACE",z.CT_SHOT,[z.create_timer_sensor(3)],null,function(d,a,c){y.hide_victory_element(1);y.show_replay_button(1)})}function x(d){return w[d].num_gems==t.OBELISK_NUM_GEMS}function D(){for(var d=0;d<t.NUM_OBELISKS;d++){w[d].num_gems=
0;for(var a=1;a<=t.OBELISK_NUM_GEMS;a++){var c=k.get_object_by_dupli_name("obelisk_"+d,t.OBELISKS_GEMS_NAME[d]+"_0"+a);c&&k.hide_object(c)}switch(t.LEVEL_NAME){case "volcano":a=t.ISLES_SHIELD_DUPLI_NAME_LIST;a[2]="island_shield_"+d;a=k.get_object_by_dupli_name_list(a);r.set_frame(a,0);break;case "dungeon":a=k.get_object_by_dupli_name("level_02_enviroment",t.FLOOR_MAGIC_NAME),m.set_nodemat_value(a,["floor_magic_0"+(d+1),"Value"],0)}}}function F(d){for(var a=0;a<t.NUM_OBELISKS;a++)if(w[a].color==d)return a;
return-1}var z=b("controls"),k=b("scenes"),r=b("animation"),c=b("sfx"),h=b("transform"),m=b("objects"),d=b("game_config"),l=b("character"),A=b("enemies"),g=b("environment"),y=b("interface"),t=null,q=null,R=new Float32Array(3),K=new Float32Array(4),w=[];a.init=function(a,c){t=c;var b=l.get_wrapper(),g=function(f,a,c){1==c&&b.gem_slot&&f.num_gems!=t.OBELISK_NUM_GEMS&&(a=b.gem_slot.color,a==f.color||a==d.CL_MULTI)&&(l.remove_gem(),f=F(f.color),n(f,1))};if("volcano"==t.LEVEL_NAME)C();else if("dungeon"==
t.LEVEL_NAME)var e=k.get_object_by_dupli_name("level_02_enviroment",t.FLOOR_MAGIC_NAME),A=function(f,d,a,c){a=c.num_gems/t.OBELISK_NUM_GEMS;var J=c.magic_val;f=z.get_sensor_value(f,d,0);J!=a&&(J<a?c.magic_val+=.25*f:J>a&&(c.magic_val-=.25*f),m.set_nodemat_value(e,["floor_magic_0"+(c.id+1),"Value"],c.magic_val))};for(var h=0;h<t.NUM_OBELISKS;h++){var J=k.get_object_by_dupli_name("obelisk_"+h,"obelisk_collision"),Q=t.OBELISKS_GEMS_NAME[h],f={num_gems:0,gem_health:0,color:G(Q),id:h,magic_val:0},J=z.create_collision_sensor(J,
"CHARACTER");z.create_sensor_manifold(f,"FILL_OBELISK_"+Q,z.CT_TRIGGER,[J],null,g);w.push(f);"dungeon"==t.LEVEL_NAME&&(m.set_nodemat_value(e,["floor_magic_0"+(h+1),"Value"],0),z.create_sensor_manifold(e,"FLOOR_MAGIC"+h,z.CT_CONTINUOUS,[a],null,A,f))}q=k.get_object_by_dupli_name("character",d.GEM_MOUNT_SPEAKER);D()};a.try_to_capture=v;a.is_filled=x;a.num_gems=function(a){return w[a].num_gems};a.damage_obelisk=function(a){--w[a].gem_health||(w[a].gem_health=t.OBELISK_GEM_HEALTH,n(a,-1))};a.reset=D;
a.get_id_by_color=F});if(b4w.module_check("gems"))throw"Failed to register module: gems";
b4w.register("gems",function(a,b){function G(a){if(a.state!=p.GM_SPARE)return!1;if(a.color==p.CL_MULTI)return!0;a=x.get_id_by_color(a.color);return!x.is_filled(a)}var C=b("controls"),n=b("scenes");b("animation");b("sfx");var v=b("transform");b("util");var e=b("constraints");b("vec3");var p=b("game_config"),x=b("obelisks"),D=b("character"),F=[],z=null;a.init=function(a){z=a;a=function(a,d,c,b){1==c&&D.add_gem(b)};for(var b=0;b<z.GEMS_EMPTIES.length;b++){var c=z.GEMS_EMPTIES[b],e=z.GEMS_NAMES[b],m=
n.get_object_by_name(c),c=n.get_object_by_dupli_name(c,e);if(m&&c){switch(n.get_object_name(c)){case "gem_B":var d=p.CL_BLUE;break;case "gem_R":d=p.CL_RED;break;case "gem_G":d=p.CL_GREEN;break;case "gem_Y":d=p.CL_YELLOW;break;case "gem_P":d=p.CL_PURPLE;break;case "gem_M":d=p.CL_MULTI}m={empty:m,color:d,state:p.GM_SPARE};F.push(m);e=C.create_collision_sensor(c,"CHARACTER");C.create_sensor_manifold(c,"PICK_GEM",C.CT_TRIGGER,[e],null,a,m)}}};a.spawn=function(a){for(var b=0,c=0;c<F.length;c++)G(F[c])&&
b++;if(b)for(b=Math.floor(b*Math.random()),c=0;c<F.length;c++){var e=F[c];if(G(e)&&0==b--){v.set_translation_v(e.empty,a);e.state=p.GM_LAYING;break}}};a.reset=function(){for(var a=0;a<F.length;a++){var b=F[a],c=b.empty;e.remove(c);v.set_translation_v(c,p.DEFAULT_POS);b.state=p.GM_SPARE}}});if(b4w.module_check("interface"))throw"Failed to register module: interface";
b4w.register("interface",function(a,b){function G(a,b){function n(k,c,h){k=z-p.global_timeline();0>k?e.remove_sensor_manifold(null,"SHOW_"+a.id):a.style.opacity=1-k/b}b=b||0;a.style.opacity=0;a.style.visibility="visible";var z=p.global_timeline()+b;if(!e.check_sensor_manifold(null,"SHOW_"+a.id)){var k=e.create_elapsed_sensor();e.create_sensor_manifold(null,"SHOW_"+a.id,e.CT_CONTINUOUS,[k],null,n)}}function C(a,b){function n(c,h,m){c=k-p.global_timeline();0>c?(a.style.visibility="hidden",e.remove_sensor_manifold(null,
"HIDE_"+a.id)):a.style.opacity=c/b*z}b=b||0;var z=a.style.opacity,k=p.global_timeline()+b;if(!e.check_sensor_manifold(null,"HIDE_"+a.id)){var r=e.create_elapsed_sensor();e.create_sensor_manifold(null,"HIDE_"+a.id,e.CT_CONTINUOUS,[r],null,n)}}var n=b("character"),v=b("game_config"),e=b("controls"),p=b("main");a.init=function(a){document.getElementById("replay").addEventListener("touchstart",a,!1);document.getElementById("replay").addEventListener("click",a,!1);document.getElementById("life_bar").style.visibility=
"visible"};a.update_hp_bar=function(a){a=n.get_wrapper().hp;var b=document.getElementById("life_bar_green"),e=document.getElementById("life_bar_red"),p=document.getElementById("life_bar_mid"),k=192/v.MAX_CHAR_HP,r=Math.max(a*k,0);a=Math.min((v.MAX_CHAR_HP-a)*k,192);b.style.width=r+"px";e.style.width=a+"px";p.style.left=r+19+"px"};a.setup_touch_controls=function(a,b,n,p,k,r){function c(c){c.preventDefault();c=c.changedTouches;for(var h=0;h<c.length;h++)c[h].identifier==m?(e.set_custom_sensor(b,0),
e.set_custom_sensor(p,0),e.set_custom_sensor(n,0),e.set_custom_sensor(a,0),A.style.visibility="hidden",g.style.visibility="hidden",m=null):c[h].identifier==d?(e.set_custom_sensor(k,0),d=null):c[h].identifier==l&&(e.set_custom_sensor(r,0),l=null)}var h=new Float32Array(2),m,d,l,A=document.getElementById("control_tap"),g=document.getElementById("control_circle"),y=A.clientWidth/2,t=g.clientWidth/2;document.getElementById("canvas3d").addEventListener("touchstart",function(a){a.preventDefault();var d=
window.innerWidth;a=a.changedTouches;for(var c=0;c<a.length;c++){var b=a[c],l=b.clientX,e=b.clientY;if(l>d/2)break;h[0]=l;h[1]=e;m=b.identifier;A.style.visibility="visible";A.style.left=l-y+"px";A.style.top=e-y+"px";g.style.visibility="visible";g.style.left=l-t+"px";g.style.top=e-t+"px"}},!1);document.getElementById("control_jump").addEventListener("touchstart",function(a){a.preventDefault();a=a.changedTouches;for(var c=0;c<a.length;c++){var b=a[c];e.set_custom_sensor(k,1);d=b.identifier}},!1);document.getElementById("control_attack").addEventListener("touchstart",
function(a){a.preventDefault();a=a.changedTouches;for(var c=0;c<a.length;c++){var d=a[c];e.set_custom_sensor(r,1);l=d.identifier}},!1);document.getElementById("canvas3d").addEventListener("touchmove",function(c){c.preventDefault();e.set_custom_sensor(b,0);e.set_custom_sensor(p,0);e.set_custom_sensor(n,0);e.set_custom_sensor(a,0);var d=window.innerWidth;c=c.changedTouches;for(var l=0;l<c.length;l++){var g=c[l],m=g.clientX,g=g.clientY;if(m>d/2)break;A.style.left=m-y+"px";A.style.top=g-y+"px";var m=
m-h[0],g=g-h[1],k=Math.sqrt(m*m+g*g);if(16>k)break;m/=k;g=-g/k;m>Math.cos(3*Math.PI/8)?e.set_custom_sensor(a,1):m<-Math.cos(3*Math.PI/8)&&e.set_custom_sensor(n,1);g>Math.sin(Math.PI/8)?e.set_custom_sensor(b,1):g<-Math.sin(Math.PI/8)&&e.set_custom_sensor(p,1)}},!1);document.getElementById("canvas3d").addEventListener("touchend",c,!1);document.getElementById("controls").addEventListener("touchend",c,!1);document.getElementById("control_jump").style.visibility="visible";document.getElementById("control_attack").style.visibility=
"visible"};a.show_replay_button=function(a){var b=document.getElementById("replay");G(b,a)};a.hide_replay_button=function(a){var b=document.getElementById("replay");C(b,a)};a.show_victory_element=function(a){var b=document.getElementById("victory");G(b,a)};a.hide_victory_element=function(a){var b=document.getElementById("victory");C(b,a)}});if(b4w.module_check("bonuses"))throw"Failed to register module: bonuses";
b4w.register("bonuses",function(a,b){function G(a){function d(a,d,b,l){if(1==b)switch(v.set_translation_v(l.empty,n.DEFAULT_POS),l.type){case n.BTYPE_HP:D.apply_hp_potion();x.play_def(z);break;case n.BTYPE_LAVA:h<=n.LAVA_FALL_LENGTH&&D.apply_lava_protect();h=n.BONUS_LAVA_PROT_TIME;x.play_def(k);break;case n.BTYPE_SHIELD:c<=n.SHIELD_FLASH_LENGTH&&D.apply_shield(),c=n.BONUS_SHIELD_TIME,x.play_def(r)}}function b(a,c,d,l){a=e.get_sensor_value(a,c,0);l.lifetime-=a;0<l.lifetime?(a=l.lifetime,4<a||(l=l.body,
a*=n.BONUS_FLASH_SPEED,.5<(1>a?a:a%Math.floor(a))?p.hide_object(l):p.show_object(l))):(v.set_translation_v(l.empty,n.DEFAULT_POS),l.is_spawned=!1)}for(var A=0;A<F.length;A++){var g=F[A],y=g.body,t=e.create_collision_sensor(y,"CHARACTER");e.create_sensor_manifold(y,"BONUS",e.CT_TRIGGER,[t],null,d,g);e.create_sensor_manifold(y,"BONUS_LIFETIME",e.CT_CONTINUOUS,[a],null,b,g)}}function C(a,c,b){for(var e=0;e<a.length;e++){var g;var h=a[e];g=c;var k=b,q=p.get_object_by_name(h),h=p.get_object_by_dupli_name(h,
k);g=q&&h?{empty:q,body:h,lifetime:n.BONUS_LIFETIME,type:g,is_spawned:!1}:null;g&&F.push(g)}}var n=b("game_config"),v=b("transform"),e=b("controls"),p=b("scenes"),x=b("sfx"),D=b("character"),F=[],z=null,k=null,r=null,c=0,h=0;new Float32Array(3);a.init=function(a,d){z=p.get_object_by_dupli_name("character",n.CHAR_HEAL_SPEAKER);k=p.get_object_by_dupli_name("character",n.CHAR_LAVA_SPEAKER);r=p.get_object_by_dupli_name("character",n.CHAR_SHIELD_SPEAKER);C(n.HP_BONUSES_EMPTIES,n.BTYPE_HP,"potion_HP");
C(n.LAVA_BONUSES_EMPTIES,n.BTYPE_LAVA,"potion_LAVA");C(n.SHIELD_BONUSES_EMPTIES,n.BTYPE_SHIELD,"potion_SHIELD");G(a);e.create_sensor_manifold(null,"BONUS_TIMER",e.CT_CONTINUOUS,[a],null,function(a,d){var b=e.get_sensor_value(a,d,0);0<c&&(c-b<n.SHIELD_FLASH_LENGTH&&D.remove_shield(),c-=b);0<h&&(h-b<n.LAVA_FALL_LENGTH&&D.remove_lava_protect(),h-=b)})};a.spawn=function(a){for(var c=Math.floor(3*Math.random()),b=0;b<F.length;b++){var e=F[b];if(!e.is_spawned&&e.type==c){a[1]+=.05;v.set_translation_v(e.empty,
a);e.lifetime=n.BONUS_LIFETIME;e.is_spawned=!0;p.show_object(e.body);break}}};a.reset=function(){function a(c){for(var b=0;b<c.length;b++){var e=p.get_object_by_name(c[b]);v.set_translation_v(e,n.DEFAULT_POS)}}a(n.HP_BONUSES_EMPTIES);a(n.SHIELD_BONUSES_EMPTIES);a(n.LAVA_BONUSES_EMPTIES)};a.set_shield_time=function(a){c=a};a.set_lava_protect_time=function(a){h=a};a.lava_protect_time_left=function(){return h};a.shield_time_left=function(){return c}});if(b4w.module_check("enemies"))throw"Failed to register module: enemies";
b4w.register("enemies",function(a,b){function G(a,c){var f=a.empty.name;a.walk_speaker=r.get_object_by_dupli_name(f,g.GOLEM_WALK_SPEAKER);a.attack_speaker=r.get_object_by_dupli_name(f,g.GOLEM_ATTACK_SPEAKER);a.hit_speaker=r.get_object_by_dupli_name(f,g.GOLEM_HIT_SPEAKER);a.getout_speaker=r.get_object_by_dupli_name(f,g.GOLEM_GETOUT_SPEAKER);switch(c){case "lava":a.type=g.EN_TYPE_GOLEM_LAVA;break;case "stone":a.type=g.EN_TYPE_GOLEM_STONE}a.death_anim="golem_death";a.walk_anim="golem_walk";a.atack_anim=
["golem_atack_01","golem_atack_02","golem_atack_03"];a.getout_anim="golem_"+c+"_getout";a.death_empty_name="golem_"+c+"_death";f=m.get_object_bounding_box(a.body);a.height=f.max_y-f.min_y}function C(a,b,f){if(0>=a.hp){b=a.empty;f=r.get_object_by_name(a.death_empty_name);var d=r.get_object_by_dupli_name(a.death_empty_name,g.GOLEM_DEATH_RIG),l=r.get_object_by_dupli_name(a.death_empty_name,g.GOLEM_DEATH_BLOW),u=B,n=I;m.get_translation(b,u);m.get_rotation(b,n);m.set_translation_v(f,u);m.set_rotation_v(f,
n);c.apply(d,a.death_anim);c.set_behavior(d,c.AB_FINISH_STOP);c.play(d);c.play(l);h.stop(a.walk_speaker);m.set_translation_v(b,g.DEFAULT_POS);K.spawn(u);"volcano"==w.LEVEL_NAME&&(b=a.island_id,a.island_id=-1,q.try_to_capture(b));a.hp=100;D(a,g.GS_NONE)}else switch(f=k.get_sensor_value(a,b,1),a.dist_to_ground=10*f-a.height/2,a.state){case g.GS_ATTACKING:!a.attack_done&&c.get_frame(a.rig)>=g.GOLEM_ATTACK_ANIM_FRAME&&(a.last_target==g.GT_CHAR?t.check_attack(a.attack_point,y.get_wrapper().phys_body,g.GOLEM_ATTACK_DIST)&&
(b=g.GOLEM_ATTACK_STRENGTH,0<R.shield_time_left()&&(b*=g.BONUS_SHIELD_EFFECT),y.change_hp(-b),h.play_def(a.hit_speaker)):a.last_target==g.GT_OBELISK&&(b=a.island_id,q.num_gems(b)&&q.damage_obelisk(b),h.play_def(a.hit_speaker)),a.attack_done=!0);break;case g.GS_WALKING:b=k.get_sensor_value(a,b,0),f=y.get_wrapper(),"volcano"==w.LEVEL_NAME?(d=a.island_id,f.island==d&&0<f.hp?(v(a,f.phys_body,b),a.last_target=g.GT_CHAR):q.num_gems(d)?(f=r.get_object_by_dupli_name("obelisk_"+d,"obelisk"),v(a,f,b),a.last_target=
g.GT_OBELISK):e(a,b)):"dungeon"==w.LEVEL_NAME?0<f.hp&&t.check_visibility(a,f)?(v(a,f.phys_body,b),a.speed=2*g.GOLEM_SPEED,c.set_speed(a.rig,2),a.last_target=g.GT_CHAR):e(a,b):e(a,b)}}function n(a){for(var b=[],f=[],c=0;c<w.GOLEM_SPAWN_POINTS.length;c++){var d=r.get_object_by_name(w.GOLEM_SPAWN_POINTS[c]),e=m.get_translation(d),d=m.get_rotation(d);b.push(e);f.push(d)}k.create_sensor_manifold(null,"GOLEMS_SPAWN",k.CT_CONTINUOUS,[a],null,function(a,c){var d;a:{for(d=0;d<H.length;d++){var e=H[d];if(e.state==
g.GS_NONE){d=e;break a}}d=null}if(d&&(e=k.get_sensor_value(a,c,0),N-=e,0>=N)){N=g.GOLEMS_SPAWN_INTERVAL;if("volcano"==w.LEVEL_NAME){if(e=F(),null==e)return}else e=0;var J=e,E=d.empty,e="volcano"==w.LEVEL_NAME?b.length/w.NUM_OBELISKS:b.length,u=Math.floor(Math.random()*e),u=e*J+u,e=b[u],u=f[u];m.set_translation_v(E,e);m.set_rotation_v(E,u);D(d,g.GS_GETTING_OUT);h.play_def(d.getout_speaker);if("volcano"==w.LEVEL_NAME)d.island_id=J,l.copy(e,d.dest_pos);else{for(var J=w.GOLEM_PATROL_POINTS,E=J.length,
u=d.dest_pos,q=1E3,n=-1,p=0;p<E;p++){var A=r.get_object_by_name(J[p]);m.get_translation(A,L);A=l.distance(L,e);A<q&&(q=A,n=p,l.copy(L,u),u[1]=e[1])}d.dest_point=n}}})}function v(a,b,d){var e=B,E=L;m.get_translation(a.empty,e);m.get_translation(b,E);E[1]=e[1];l.copy(E,a.dest_pos);b=l.distance(e,E);e=p(a,d);b>=g.GOLEM_ATTACK_DIST?x(a,d):e<.05*Math.PI&&(d=a.empty,b=a.attack_point,e=B,E=L,c.set_speed(a.rig,2),a.attack_done=!1,D(a,g.GS_ATTACKING),m.get_translation(d,e),l.scaleAndAdd(e,E,g.GOLEM_ATTACK_DIST,
b),b[1]+=a.height/2,h.is_play(a.walk_speaker)&&h.stop(a.walk_speaker),h.play_def(a.attack_speaker))}function e(a,b){a.speed=g.GOLEM_SPEED;c.set_speed(a.rig,1);var d=a.dest_pos,e=B;m.get_translation(a.empty,e);var E=e[1];e[1]=d[1];d=l.distance(e,d);e[1]=E;if(!(.05<d&&a.last_target==g.GT_POINT))if(a.last_target=g.GT_POINT,"volcano"==w.LEVEL_NAME)b:{for(var E=a.dest_pos,d=a.dest_point,u=a.island_id,h=w.GOLEM_PATROL_POINTS,k=h.length/w.NUM_OBELISKS,M=Math.random(),q=Math.floor(k*M),n=0,M=0;M<k;M++)if(M!=
d&&n++==q){u=r.get_object_by_name(h[k*u+M]);m.get_translation(u,E);E[1]=e[1];a.prev_dest=d;a.dest_point=M;break b}a.dest_point=-1}else E=a.dest_pos,d=a.dest_point,u=w.GOLEM_PATROL_POINTS,h=w.GOLEM_PATROL_MAP[d],k=h.length-1,M=Math.random(),h=h[Math.floor(k*M)],u=r.get_object_by_name(u[h]),m.get_translation(u,E),E[1]=e[1],a.prev_dest=d,a.dest_point=h;p(a,b);x(a,b)}function p(a,b){var c=a.empty,e=a.dest_pos,E=B,u=L,h=O,k=I,M=P;m.get_translation(c,E);m.get_rotation(c,k);l.transformQuat(d.AXIS_Z,k,u);
l.subtract(e,E,h);h[1]=0;l.normalize(h,h);A.rotationTo(u,h,M);A.multiply(M,k,M);e=l.dot(u,h);e=Math.acos(1<e?1:-1>e?-1:e);E=Math.abs(e)/Math.PI;A.slerp(k,M,Math.min(b/E*g.GOLEM_ROT_SPEED,1),M);m.set_rotation_v(c,M);return e}function x(a,b){var c=B,e=L,g=I,u=a.empty,k=a.walk_speaker;m.get_rotation(u,g);m.get_translation(u,c);l.transformQuat(d.AXIS_Z,g,e);l.scaleAndAdd(c,e,a.speed*b,c);e=b/3;c[1]-=a.dist_to_ground>e?e:a.dist_to_ground<-e?-e:e;0<c[1]&&(c[1]=0);m.set_translation_v(u,c);h.is_play(k)||
(h.play_def(k),h.cyclic(k,!0))}function D(a,b){var d=a.rig;switch(b){case g.GS_WALKING:c.apply(d,a.walk_anim);c.set_behavior(d,c.AB_CYCLIC);c.play(d);break;case g.GS_ATTACKING:var e=Math.floor(a.atack_anim.length*Math.random());c.apply(d,a.atack_anim[e]);c.play(d,function(){a.state!=g.GS_NONE&&D(a,g.GS_WALKING)});break;case g.GS_GETTING_OUT:c.apply(d,a.getout_anim),c.play(d,function(){a.state!=g.GS_NONE&&D(a,g.GS_WALKING)})}a.state=b}function F(){for(var a=w.NUM_OBELISKS,b=0;b<H.length;b++)z(b)||
a--;if(0==a)return null;for(var a=Math.floor(Math.random()*a),d=0,b=0;b<w.NUM_OBELISKS;b++)if(z(b)&&d++==a)return b;return null}function z(a){if(q.is_filled(a))return!1;for(var b=0;b<H.length;b++)if(H[b].island_id==a)return!1;return!0}var k=b("controls"),r=b("scenes"),c=b("animation"),h=b("sfx"),m=b("transform"),d=b("util"),l=b("vec3"),A=b("quat"),g=b("game_config"),y=b("character"),t=b("combat"),q=b("obelisks"),R=b("bonuses"),K=b("gems"),w=null,H=[],B=new Float32Array(3),L=new Float32Array(3),O=
new Float32Array(3),I=new Float32Array(4),P=new Float32Array(4),N=0;a.init=function(a,b){w=b;N=g.GOLEMS_SPAWN_INTERVAL;for(var d=0;d<w.GOLEMS_EMPTIES.length;d++){var c=w.GOLEMS_EMPTIES[d],e=r.get_object_by_name(c),l=r.get_object_by_dupli_name(c,"golem_collider"),c=r.get_object_by_dupli_name(c,"golem_armature");l&&c&&e&&(e={body:l,rig:c,empty:e,height:0,type:g.EN_TYPE_GOLEM_LAVA,view_distance:10,walk_speaker:null,attack_speaker:null,hit_speaker:null,getout_speaker:null,death_empty_name:null,hp:g.GOLEM_HP,
speed:g.GOLEM_SPEED,island_id:-1,dest_point:-1,prev_dest:-1,dest_pos:new Float32Array(3),dist_to_ground:0,last_target:g.GT_POINT,state:g.GS_NONE,attack_point:new Float32Array(3),attack_done:!1},c=-1!=l.name.indexOf("lava")?"lava":"stone",G(e,c),l=k.create_ray_sensor(l,[0,0,0],[0,-10,0],"GROUND",!1,!1,!0),k.create_sensor_manifold(e,"GOLEM",k.CT_CONTINUOUS,[a,l],function(a){return!0},C),H.push(e),t.append_enemy(e))}n(a)};a.reset=function(){N=g.GOLEMS_SPAWN_INTERVAL;for(var a=0;a<H.length;a++){var b=
H[a];b.island_id=-1;D(b,g.GS_NONE);m.set_translation_v(b.empty,g.DEFAULT_POS);h.stop(b.walk_speaker)}};a.island_has_enemies=function(a){for(var b=0;b<H.length;b++)if(H[b].island_id==a)return!0;return!1}});if(b4w.module_check("combat"))throw"Failed to register module: combat";
b4w.register("combat",function(a,b){function G(a,b,p){var k=e;C.get_translation(b,k);return n.distance(k,a)<p?!0:!1}var C=b("transform"),n=b("vec3"),v=b("game_config"),e=new Float32Array(3),p=new Float32Array(3),x=[];a.append_enemy=function(a){x.push(a)};a.process_attack_on_enemies=function(a,b){for(var e=0;e<x.length;e++){var k=x[e];if(!(0>=k.hp||k.state==v.GS_NONE)&&G(a,k.empty,b))return k.hp-=v.CHAR_ATTACK_STR,!0}return!1};a.check_attack=G;a.check_visibility=function(a,b){var v=C.get_translation(a.body,
e),k=C.get_translation(b.body,p);return n.distance(v,k)>a.view_distance?!1:!0}});if(b4w.module_check("character"))throw"Failed to register module: character";
b4w.register("character",function(a,b){function G(){for(var a=function(a,b,d){f.island=1==d?parseInt(b[b.length-1]):-1},b=0;b<H.NUM_OBELISKS;b++){var d=c.create_collision_sensor(f.picker,"ISLAND"+b);c.create_sensor_manifold(f.picker,"ISLE_COLL"+b,c.CT_TRIGGER,[d],null,a)}}function C(a){var b=c.create_ray_sensor(f.phys_body,[0,0,0],[0,-q.CHAR_RAY_LENGTH,0],"GROUND",!0),d=c.create_ray_sensor(f.phys_body,[0,0,0],[0,-q.CHAR_RAY_LENGTH,0],"LAVA",!0),e=c.create_ray_sensor(f.phys_body,[0,0,0],[0,-q.CHAR_RAY_LENGTH,
0],"COMMON",!0);c.create_sensor_manifold(f.phys_body,"GROUND SENS",c.CT_TRIGGER,[b,d,e],function(a){return a[0]||a[1]||a[2]},function(b,d,e){c.set_custom_sensor(a,1==e?1:0)})}function n(a,b,e){function g(a,b,e){if(f.state==q.CH_ATTACK)m.set_character_move_dir(a,0,0);else{var h=c.get_sensor_value(a,b,6);if(1==e){switch(b){case "FORWARD":var u=1;break;case "BACKWARD":u=-1}f.state==q.CH_STILL&&h&&(d.apply(f.rig,"character_run"),d.play(f.rig),d.set_behavior(f.rig,d.AB_CYCLIC));f.state=q.CH_RUN}else u=
0,f.state==q.CH_RUN&&h&&(d.apply(f.rig,"character_idle_01"),d.set_behavior(f.rig,d.AB_CYCLIC),d.play(f.rig)),f.state=q.CH_STILL;u&&h?l.is_play(B)||l.play_def(B):l.is_play(B)&&l.stop(B);m.set_character_move_dir(a,u,0)}}var h=c.create_keyboard_sensor(c.KEY_W),u=c.create_keyboard_sensor(c.KEY_S),E=c.create_keyboard_sensor(c.KEY_UP),k=c.create_keyboard_sensor(c.KEY_DOWN);a=[h,E,a,u,k,b,e];c.create_sensor_manifold(f.phys_body,"FORWARD",c.CT_CONTINUOUS,a,function(a){return a[0]||a[1]||a[2]},g);c.create_sensor_manifold(f.phys_body,
"BACKWARD",c.CT_CONTINUOUS,a,function(a){return a[3]||a[4]||a[5]},g);d.apply(f.rig,"character_idle_01");d.play(f.rig);d.set_behavior(f.rig,d.AB_CYCLIC);f.body&&(d.apply(f.body,"HEAL_run"),d.apply(f.body,"LAVA_grow",d.SLOT_1),d.apply(f.body,"SHIELD_grow",d.SLOT_2));f.shield_sphere&&d.apply(f.shield_sphere,"SHIELD_GLOW_grow");l.stop(B)}function v(a,b,d){function e(a,b,d){if(f.state!=q.CH_ATTACK){var l=c.get_sensor_value(a,"LEFT",6);if(1==d)switch(b){case "LEFT":m.character_rotation_inc(a,l*q.ROT_SPEED,
0);break;case "RIGHT":m.character_rotation_inc(a,-l*q.ROT_SPEED,0)}}}var l=c.create_keyboard_sensor(c.KEY_A),g=c.create_keyboard_sensor(c.KEY_D),h=c.create_keyboard_sensor(c.KEY_LEFT),u=c.create_keyboard_sensor(c.KEY_RIGHT);a=[l,h,b,g,u,a,d];c.create_sensor_manifold(f.phys_body,"LEFT",c.CT_CONTINUOUS,a,function(a){return a[0]||a[1]||a[2]},e);c.create_sensor_manifold(f.phys_body,"RIGHT",c.CT_CONTINUOUS,a,function(a){return a[3]||a[4]||a[5]},e)}function e(a,b){var e=c.create_keyboard_sensor(c.KEY_SPACE);
c.create_sensor_manifold(f.phys_body,"JUMP",c.CT_TRIGGER,[e,a,b],function(a){return a[0]||a[1]},function(a,b,e){1==e&&f.state!=q.CH_ATTACK&&(m.character_jump(a),c.get_sensor_value(a,b,2)&&(b=Math.floor(2*Math.random()),l.play_def(N[b]),d.apply(f.rig,"character_jump"),d.set_behavior(f.rig,d.AB_FINISH_STOP),d.play(f.rig)))});c.create_sensor_manifold(f.phys_body,"LANDING",c.CT_TRIGGER,[b],null,function(a,b,c){1==c&&(l.play_def(I),f.state==q.CH_STILL?(d.apply(f.rig,"character_idle_01"),d.set_behavior(f.rig,
d.AB_CYCLIC),d.play(f.rig)):f.state==q.CH_RUN&&(d.apply(f.rig,"character_run"),d.set_behavior(f.rig,d.AB_CYCLIC),d.play(f.rig)))})}function p(a,b){function e(a){d.apply(f.rig,"character_idle_01");d.set_behavior(f.rig,d.AB_CYCLIC);d.play(f.rig);f.state=q.CH_STILL}var h=c.create_keyboard_sensor(c.KEY_ENTER),k=!1;c.create_sensor_manifold(f.phys_body,"ATTACK",c.CT_TRIGGER,[h,a],function(a){return a[0]||a[1]},function(a,b,c){1==c&&f.state!=q.CH_ATTACK&&(f.state=q.CH_ATTACK,a=Math.floor(3*Math.random())+
1,d.apply(f.rig,"character_atack_0"+a),d.set_behavior(f.rig,d.AB_FINISH_STOP),d.play(f.rig,e),m.set_character_move_dir(f.phys_body,0,0),k=!1,l.is_play(B)&&l.stop(B),l.play_def(L),a=Math.floor(3*Math.random()),l.play_def(J[a]))});c.create_sensor_manifold(f.phys_body,"DAMAGE_GOLEMS",c.CT_CONTINUOUS,[b],null,function(a,b,c){if(f.state==q.CH_ATTACK&&!k&&d.get_frame(f.rig)>=q.CHAR_ATTACK_ANIM_FRAME){a=E;b=u;c=U;var e=T,h=q.CHAR_ATTACK_DIST;A.get_translation(f.phys_body,a);A.get_rotation(f.phys_body,e);
y.transformQuat(g.AXIS_Z,e,b);y.scaleAndAdd(a,b,h,c);R.process_attack_on_enemies(c,h)&&(l.play_def(O),d.play(f.hitsparks));k=!0}})}function x(){c.check_sensor_manifolds(f.phys_body)&&c.remove_sensor_manifold(f.phys_body);m.set_character_move_dir(f.phys_body,0,0);l.stop(B)}function D(){d.apply(f.body,"LAVA_fall",d.SLOT_1);d.set_behavior(f.body,d.AB_FINISH_STOP,d.SLOT_1);d.play(f.body,null,d.SLOT_1);w.set_lava_protect_time(0)}function F(){d.apply(f.body,"SHIELD_flash",d.SLOT_2);d.set_behavior(f.body,
d.AB_FINISH_STOP,d.SLOT_2);d.play(f.body,null,d.SLOT_2);d.apply(f.shield_sphere,"SHIELD_GLOW_fall");d.set_behavior(f.shield_sphere,d.AB_FINISH_STOP);d.play(f.shield_sphere);w.set_shield_time(0)}function z(a){if(!(0>=f.hp)){var b=r.global_timeline();if(0>a&&S<b-.5){var c=Math.floor(2*Math.random());l.play_def(Q[c]);S=b}f.hp+=a;f.hp=Math.min(f.hp,q.MAX_CHAR_HP);0>=f.hp&&(x(),H.MUSIC_SPEAKERS&&(l.clear_playlist(),a=h.get_object_by_dupli_name("enviroment",H.MUSIC_INTRO_SPEAKER),l.stop(a),a=h.get_object_by_dupli_name("enviroment",
H.MUSIC_END_SPEAKER),l.play_def(a)),a=h.get_object_by_dupli_name("character",q.CHAR_DEATH_SPEAKER),l.play_def(a),d.apply(f.rig,"character_death"),d.set_behavior(f.rig,d.AB_FINISH_STOP),d.play(f.rig),K.show_replay_button(1),f.gem_slot&&k(),0<w.shield_time_left&&F(),0<w.lava_protect_time_left&&D());K.update_hp_bar()}}function k(){var a=f.gem_slot.empty;t.remove(a);A.set_translation_v(a,q.DEFAULT_POS);A.set_scale(a,1);f.gem_slot.state=q.GM_SPARE;f.gem_slot=null}var r=b("main"),c=b("controls"),h=b("scenes"),
m=b("physics"),d=b("animation"),l=b("sfx"),A=b("transform"),g=b("util"),y=b("vec3"),t=b("constraints"),q=b("game_config"),R=b("combat"),K=b("interface"),w=b("bonuses");b("environment");var H=null,B=null,L=null,O=null,I=null,P=null,N=[],J=[],Q=[],f=null,S=-100,E=new Float32Array(3),u=new Float32Array(3),U=new Float32Array(3),T=new Float32Array(4);a.init_wrapper=function(a,b){H=a;f={phys_body:h.get_first_character(),rig:h.get_object_by_dupli_name("character","character_rig"),body:h.get_object_by_dupli_name("character",
"character_body_"+b),picker:h.get_object_by_dupli_name("character","character_picker"),shield_sphere:h.get_object_by_dupli_name("character","shield_sphere"),hitsparks:h.get_object_by_dupli_name("character","sword_hitsparks_emitter"),hp:q.MAX_CHAR_HP,state:q.CH_STILL,gem_slot:null,island:-1};d.apply_def(f.hitsparks);d.set_behavior(f.hitsparks,d.AB_FINISH_RESET)};a.setup_controls=function(a){B=h.get_object_by_dupli_name("character",q.CHAR_RUN_SPEAKER);L=h.get_object_by_dupli_name("character",q.CHAR_ATTACK_SPEAKER);
O=h.get_object_by_dupli_name("character",q.CHAR_SWORD_SPEAKER);I=h.get_object_by_dupli_name("character",q.CHAR_LANDING_SPEAKER);P=h.get_object_by_dupli_name("character",q.GEM_PICKUP_SPEAKER);for(var b=0;b<q.CHAR_JUMP_SPKS.length;b++){var d=h.get_object_by_dupli_name("character",q.CHAR_JUMP_SPKS[b]);N.push(d)}for(b=0;b<q.CHAR_ATTACK_VOICE_SPKS.length;b++)d=h.get_object_by_dupli_name("character",q.CHAR_ATTACK_VOICE_SPKS[b]),J.push(d);for(b=0;b<q.CHAR_HURT_SPKS.length;b++)d=h.get_object_by_dupli_name("character",
q.CHAR_HURT_SPKS[b]),Q.push(d);"volcano"==H.LEVEL_NAME&&G();var b=c.create_custom_sensor(0),d=c.create_custom_sensor(0),f=c.create_custom_sensor(0),l=c.create_custom_sensor(0),g=c.create_custom_sensor(0),u=c.create_custom_sensor(0),k=c.create_custom_sensor(0);C(k);var E;E=navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||
navigator.userAgent.match(/Windows Phone/i)?!0:!1;E&&K.setup_touch_controls(b,f,d,l,g,u);n(f,l,k);v(b,d,a);e(g,k);p(u,a)};a.disable_controls=x;a.reset=function(){f.state=q.CH_STILL;f.hp=q.MAX_CHAR_HP;f.island=-1;A.get_rotation(f.phys_body,T);m.set_transform(f.phys_body,H.CHAR_DEF_POS,T);m.set_character_move_dir(f.phys_body,0,0)};a.apply_hp_potion=function(){z(q.BONUS_HP_INCR);d.play(f.body)};a.apply_lava_protect=function(){d.apply(f.body,"LAVA_grow",d.SLOT_1);d.set_behavior(f.body,d.AB_FINISH_STOP,
d.SLOT_1);d.play(f.body,null,d.SLOT_1)};a.remove_lava_protect=D;a.apply_shield=function(){d.apply(f.body,"SHIELD_grow",d.SLOT_2);d.set_behavior(f.body,d.AB_FINISH_STOP,d.SLOT_2);d.play(f.body,null,d.SLOT_2);d.apply(f.shield_sphere,"SHIELD_GLOW_grow");d.set_behavior(f.shield_sphere,d.AB_FINISH_STOP);d.play(f.shield_sphere)};a.remove_shield=F;a.change_hp=z;a.add_gem=function(a){var b=a.empty;if(f.gem_slot){if(f.gem_slot==a)return;k()}b=a.empty;t.append_stiff(b,f.phys_body,q.GEM_OFFSET,q.GEM_ROT_OFFSET,
q.GEM_SCALE_OFFSET);a.state=q.GM_CARRIED;f.gem_slot=a;l.play_def(P)};a.remove_gem=k;a.get_wrapper=function(){return f}});if(b4w.module_check("environment"))throw"Failed to register module: environment";
b4w.register("environment",function(a,b){function G(a,b){function n(a,b,d){b=e.get_sensor_value(a,b,0);d=p.get_object_name(a);h[d]+=b;h[d]<=c.ROCK_FALL_DELAY||(d=m,x.get_translation(a,d),d[1]-=c.ROCK_SPEED*b,x.set_translation_v(a,d))}function g(a,b,d,l){var g=m,u=l[0];l=l[1];d=z.get_wrapper();x.get_translation(d.phys_body,g);d=e.get_sensor_value(a,b,0)?0:1;b=e.get_sensor_payload(a,b,d).coll_pos;g=D.distance(g,b);x.set_translation_v(u,b);v.set_frame(u,0,v.SLOT_ALL);v.play(u,null,v.SLOT_ALL);C(a);g<
c.ROCK_DAMAGE_RADIUS&&(u=-c.ROCK_DAMAGE,0<r.shield_time_left()&&(u*=k.BONUS_SHIELD_EFFECT),z.change_hp(u));a=p.get_object_name(a);h[a]=0;(a=Math.random()<k.BONUS_SPAWN_CHANCE)&&0==d&&r.spawn(b);F.play_def(l)}function y(a,b,d,l){d=e.get_sensor_value(a,b,0)?0:1;b=e.get_sensor_payload(a,b,d).hit_fract;d=m;var g=p.get_object_name(a);h[g]<=c.ROCK_FALL_DELAY&&(x.get_translation(a,d),d[1]-=b*c.ROCK_RAY_LENGTH-.01,x.set_translation_v(l,d));x.set_scale(l,1-b)}for(var t=0;t<c.ROCK_EMPTIES.length;t++)for(var q=
c.ROCK_EMPTIES[t],G=0;G<c.ROCK_NAMES.length;G++){var K=c.ROCK_NAMES[G],w=c.BURST_EMITTER_NAMES[G],H=c.MARK_NAMES[G],B=p.get_object_by_dupli_name(q,K),w=p.get_object_by_dupli_name(q,w),H=p.get_object_by_dupli_name(q,H),L=p.get_object_by_dupli_name(q,c.ROCK_HIT_SPEAKERS[G]),O=e.create_collision_sensor(B,"LAVA",!0),I=e.create_collision_sensor(B,"GROUND",!0),P=e.create_ray_sensor(B,[0,0,0],[0,-c.ROCK_RAY_LENGTH,0],"GROUND",!0),N=e.create_ray_sensor(B,[0,0,0],[0,-c.ROCK_RAY_LENGTH,0],"LAVA",!0);e.create_sensor_manifold(B,
"ROCK_FALL",e.CT_CONTINUOUS,[a],null,n);e.create_sensor_manifold(B,"ROCK_CRASH",e.CT_SHOT,[I,O],function(a){return a[0]||a[1]},g,[w,L]);e.create_sensor_manifold(B,"MARK_POS",e.CT_CONTINUOUS,[P,N],function(a){return a[0]||a[1]},y,H);C(B);h[K]=0}}function C(a){var b=m;b[0]=32*Math.random()-16;b[1]=16*Math.random()+8;b[2]=32*Math.random()-16;x.set_translation_v(a,b)}function n(a){var b=0,h=z.get_wrapper(),g=e.create_ray_sensor(h.phys_body,[0,0,0],[0,-k.CHAR_RAY_LENGTH,0],"LAVA",!0);e.create_sensor_manifold(h.phys_body,
"LAVA_COLLISION",e.CT_CONTINUOUS,[g,a],function(a){return a[0]},function(a,d,c,g){1==c?(a=e.get_sensor_value(a,d,1),b+=a,b>=k.LAVA_DAMAGE_INTERVAL&&(a=a<k.LAVA_DAMAGE_INTERVAL?1:Math.floor(a/k.LAVA_DAMAGE_INTERVAL),0>=r.lava_protect_time_left()&&z.change_hp(-a),b=0)):b=0});"dungeon"==c.LEVEL_NAME&&(a=p.get_object_by_dupli_name("level_02_enviroment","lava"),v.apply_def(a),v.set_behavior(a,v.AB_FINISH_STOP),v.stop(a),v.set_frame(a,0),a=p.get_object_by_dupli_name("lava_death_controller","lava_death_controller"),
v.stop(a),v.set_frame(a,0))}var v=b("animation"),e=b("controls"),p=b("scenes"),x=b("transform"),D=b("vec3"),F=b("sfx"),z=b("character"),k=b("game_config"),r=b("bonuses"),c=null,h={},m=new Float32Array(3);a.init=function(a,b){c=b;n(a);c.ROCK_EMPTIES&&G(a,c)};a.reset=function(){if("volcano"==c.LEVEL_NAME)for(var a=0;a<c.ROCK_EMPTIES.length;a++)for(var b=c.ROCK_EMPTIES[a],e=0;e<c.ROCK_NAMES.length;e++){var g=c.ROCK_NAMES[e],k=p.get_object_by_dupli_name(b,g);C(k);h[g]=0}};a.disable_environment=function(){if(c.ROCK_EMPTIES)for(var a=
0;a<c.ROCK_EMPTIES.length;a++)for(var b=c.ROCK_EMPTIES[a],h=0;h<c.ROCK_NAMES.length;h++){var g=c.MARK_NAMES[h],m=p.get_object_by_dupli_name(b,c.ROCK_NAMES[h]),g=p.get_object_by_dupli_name(b,g);e.remove_sensor_manifold(m);C(m);x.set_translation_v(g,k.DEFAULT_POS)}}});if(b4w.module_check("game_main"))throw"Failed to register module: game_main";
b4w.register("game_main",function(a,b){function G(a){var b=e.get_active_camera(),c=e.get_object_by_dupli_name("character","camera_target");v.append_semi_soft_cam(b,c,x.CAM_OFFSET,x.CAM_SOFTNESS);a=n.create_ray_sensor(c,x.CAM_OFFSET,[0,0,0],"VISUAL_BLOCKER",!0,!0,!1);n.create_sensor_manifold(c,"CAM_ADJUSTMENT",n.CT_TRIGGER,[a],null,function(a,d,e){v.remove(b);1==e?v.append_semi_soft_cam(b,c,[0,12,-9],x.CAM_SOFTNESS):v.append_semi_soft_cam(b,c,x.CAM_OFFSET,x.CAM_SOFTNESS)})}function C(){if(m.MUSIC_SPEAKERS){var a=
e.get_object_by_dupli_name("enviroment",m.MUSIC_INTRO_SPEAKER),b=e.get_object_by_dupli_name("enviroment",m.MUSIC_END_SPEAKER);a&&b&&(p.play_def(a),p.stop(b),a=p.get_duration(a)*p.get_playrate(a),n.create_sensor_manifold(null,"PLAYLIST",n.CT_SHOT,[n.create_timer_sensor(a)],null,function(a,b,d){n.remove_sensor_manifold(null,"PLAYLIST");if(!(0>=D.get_wrapper().hp)){a=[];b=m.MUSIC_SPEAKERS;for(d=0;d<b.length;d++){var c=e.get_object_by_dupli_name("enviroment",b[d]);a.push(c)}p.apply_playlist(a,0,!0)}}))}}
b("app");b("main");var n=b("controls"),v=b("constraints"),e=b("scenes");b("config");b("print");var p=b("sfx");b("transform");b("physics");b("vec3");b("quat");var x=b("game_config"),D=b("character");b("combat");var F=b("bonuses"),z=b("interface"),k=b("enemies"),r=b("obelisks"),c=b("gems"),h=b("environment"),m=null;new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(4);new Float32Array(4);a.level_load_cb=function(a,e){m=b(e+"_config");D.init_wrapper(m,e);
var p=n.create_elapsed_sensor();F.init(p,m);k.init(p,m);r.init(p,m);c.init(m);h.init(p,m);C();D.setup_controls(p);G(p);z.init(function(){document.getElementById("replay").style.visibility="hidden";n.remove_sensor_manifold(null,"PLAYLIST");D.reset();c.reset();F.reset();k.reset();r.reset();h.reset();D.setup_controls(p);z.update_hp_bar();C()})}});if(b4w.module_check("intro_main"))throw"Failed to register module: intro_main";
b4w.register("intro_main",function(a,b){function G(a,b){b?(I=a,c.enable_controls(a),preloader_bg.style.visibility="visible",C()?m.load(S+"intro_LQ.json",n,r,!0):m.load(S+"intro_HQ.json",n,r,!0)):g.log("b4w init failure")}function C(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)?
!0:!1}function n(a){P=I.width/2;N=I.height/2;h.get_camera_angles(l.get_active_camera(),J);t.enqueue([["config",t.AT_JSON,"js/intro_config.json"]],v,null);I.addEventListener("mousemove",D,!1);I.addEventListener("mouseup",F,!1)}function v(a,b,f,h){b=a.buttons_info;f=d.create_elapsed_sensor();for(h=0;h<b.length;h++){var g=b[h],k=l.get_object_by_dupli_name_list(g.button_name.split("*"));if(k){var k=k.name,m=l.get_object_by_dupli_name_list(g.mouse_over_speaker.split("*"));y.stop(m);var n=[],r=g.glow_obj_names;
if("object"==typeof r)for(var t=0;t<r.length;t++){var v=l.get_object_by_dupli_name_list(r[t].split("*"));v&&n.push(v)}else n.push(l.get_object_by_dupli_name_list(r.split("*")));w[k]={glow_objs:n,speaker:m,level_name:g.level_name,material:g.material,value_node_name:g.value_node_name,glow_grow_time:g.glow_grow_time,min_glow_value:g.min_glow_value,max_glow_value:g.max_glow_value,glow_curr_value:g.min_glow_value,outline_grow_time:g.outline_grow_time,min_outline_value:g.min_outline_value,max_outline_value:g.max_outline_value,
outline_curr_value:g.min_outline_value,stop_playlist:g.stop_playlist_onclick}}}d.create_sensor_manifold(null,"GLOW",d.CT_CONTINUOUS,[f],null,p);d.create_sensor_manifold(null,"ROT_CAMERA",d.CT_CONTINUOUS,[f],null,x);e(a);(b=c.get_url_params())&&"lang"in b&&(f=l.get_object_by_dupli_name_list(a.language_obj.split("*")),console.log("LANG OBJ",f),h=1,"ru"==b.lang&&(h=0),q.set_nodemat_value(f,["stones_n_dolmens","language_switcher"],h));Q=a.camera_rotation_fac}function e(a){B=l.get_object_by_dupli_name_list(a.intro_speaker.split("*"));
O=l.get_object_by_dupli_name_list(a.end_speaker.split("*"));a=a.playlist_speakers;for(var b=0;b<a.length;b++){var c=l.get_object_by_dupli_name_list(a[b].split("*"));y.stop(c);L.push(c);y.mute(c,!1)}a=y.get_duration(B)*y.get_playrate(B);y.mute(B,!1);y.mute(O,!1);y.stop(O);y.play_def(B);d.create_sensor_manifold(null,"PLAYLIST",d.CT_SHOT,[d.create_timer_sensor(a)],null,function(a,b,c){H||(y.stop(B),y.apply_playlist(L,0,!0))})}function p(a,b,c){a=d.get_sensor_value(a,b,0);for(var e in w){b=w[e];var f=
b.glow_curr_value,g=b.min_glow_value,h=b.max_glow_value,k=a/b.glow_grow_time;c=b.outline_curr_value;var m=b.min_outline_value,n=b.max_outline_value,p=a/b.outline_grow_time;K&&e==K.name&&(f<h&&(b.glow_curr_value+=k),void 0!==c&&c<n&&(b.outline_curr_value+=p));K&&e==K.name||(f>g&&(b.glow_curr_value-=k),void 0!==c&&c>m&&(b.outline_curr_value-=p));if(void 0!==f&&b.glow_curr_value!=f)for(f=0;f<b.glow_objs.length;f++)q.set_nodemat_value(b.glow_objs[f],[b.material,b.value_node_name],b.glow_curr_value);if(void 0!==
c&&b.outline_curr_value!=c)for(f=0;f<b.glow_objs.length;f++)l.set_outline_intensity(b.glow_objs[f],b.outline_curr_value)}}function x(a,b,c){c=l.get_active_camera();h.is_target_camera(c)&&(d.get_sensor_value(a,b,0),a=I.width/2,b=I.height/2,h.get_camera_angles(c,f),h.target_rotate(c,J[0]-(a-P)/I.width*Q,J[1]-(b-N)/I.height*Q,!0,!0))}function D(a){a.preventDefault&&a.preventDefault();var b=a.clientX;a=a.clientY;var c=l.pick_object(b,a);c&&c!=K?(K=c,(c=w[c.name])&&c.speaker&&y.play_def(c.speaker)):!c&&
K&&(K=null);P=b;N=a}function F(a){a.preventDefault&&a.preventDefault();(a=l.pick_object(a.clientX,a.clientY))&&w[a.name]&&(a=w[a.name],a.stop_playlist&&z(),a.level_name&&k(a.level_name))}function z(a){for(a=0;a<L.length;a++){var b=L[a];y.is_play(b)&&y.duck(b,0,1)}y.duck(B,0,1);setTimeout(function(){y.clear_playlist();H=!0;y.play_def(O)},1E3)}function k(a){var b=S+a+".json";I.removeEventListener("mouseup",F);I.removeEventListener("touchscreen",F);I.removeEventListener("mousemove",D);m.unload();preloader_bg.style.visibility=
"visible";m.load(b,function(b){R.level_load_cb(b,a)},r,!0)}function r(a){var b=document.getElementById("prelod_dynamic_path"),c=b.nextElementSibling;b.style.width=a+"%";c.innerHTML=a+"%";100==a&&(document.getElementById("preloader_bg").style.visibility="hidden")}var c=b("app");b("camera_anim");var h=b("camera");b("main");var m=b("data"),d=b("controls");b("constraints");var l=b("scenes"),A=b("config"),g=b("print"),y=b("sfx"),t=b("assets"),q=b("objects");b("container");b("util");b("vec3");b("quat");
b("game_config");var R=b("game_main"),K=null,w={},H=!1,B=null,L=[],O=null,I=null,P=0,N=0,J=new Float32Array(2),Q=0,f=new Float32Array(2),S=A.get_std_assets_path()+"petigors_tale/";a.init=function(){var a=C();c.init({canvas_container_id:"canvas3d",callback:G,physics_enabled:!0,quality:a?A.P_LOW:A.P_HIGH,console_verbose:!0,show_fps:!0,alpha:!1,physics_use_workers:!a,autoresize:!0})}});b4w.require("intro_main").init();
